<!DOCTYPE html>

<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Directions Service</title>
  <link rel='stylesheet' type='text/css' href='routecalc.css'>
</head>

<body>



<div id='panel'></div>

<div id='input'> 

  <div id='origin-picker'>
      <h3>Start Location</h3>
      <ul>
      <li><input name='origin' id='from-current-loc' value='current' type='radio' checked='checked'>
        <label for='current-loc-opt'>Current Location</label>
      </li>
      <li><input name='origin' id='from-cvo' value='cvo' type='radio'>
        <label for='from-cvo'>ClearVision</label>
      </li>
      <li><input name='origin' id='from-other' value='other' type='radio'>
        <label for='from-other' type='text'>Other. Specify:</label>
        <input name='origin'  id='from-other-input' type='text'>
      </li>
      </ul>
  </div>

  <div id='stops'>
    <h3>Stops</h3>
    <ul id='stop-input'>
      <li class='addr-item' id='addr0-item'>
        <input id='addr0' type='text'>
        <div  onclick='removeStop("addr0-item")'>X</div>
      </li>
    </ul>
    <div 'add-stop'>
      <button id='add-stop-button' onclick='addStop()'>Add Stop</button>
    </div>
    <div id='warning-container'></div>
  </div>

  <div id='finish-picker'>
    <h3>Finish Location</h3>
    <ul>
    <li><input name='finish' id='to-current-loc' value='current' type='radio' checked='checked'>
    <label for='to-current-loc'>Current Location</label></li>
    <li><input name='finish' id='to-cvo' value='cvo' type='radio'>
    <label for='to-cvo'>ClearVision</label></li>
    <li><input name='finish' id='to-other' value='other'type='radio'>
    <label for='to-other' type='text'>Other. Specify:</label>
    <input name='finish'  id='to-other-input' type='text'></li>
    </ul>
  </div>

</div>

<div id="map"></div>

<div id='floating-panel'>
  <div class='flat-button' id='calc-route' >Fastest Route</div>
  <div class='flat-button' id='new-route' style="display: none" onclick='reset()'>New Route</div>
  <div class='flat-button' id='start-trip' style="display: none" onclick='goToUrl()'>Start Trip</div>
</div>
  


<script>

var wps = [];             // Waypoints
var origin = "";          // An address or coordinates
var dest = "";
var wpsOptmzdOrd = [];    // Optimized order (zero-indexed integer array)

var addrTotal = 1;        // Used to distinguish ids of address inputs
var warningToggle = true; // Toggle warning messages

const CVO_ADDR = "425 Rabro Dr, Hauppauge, NY";


/**
  Callback function of maps api script
*/
function initMap() {
  // Get services and display map
  var directionsService = new google.maps.DirectionsService;
  var directionsDisplay = new google.maps.DirectionsRenderer;
  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 7,  
    center: {lat: 40.804725, lng: -73.151889}
  });
  directionsDisplay.setMap(map);
  directionsDisplay.setPanel(document.getElementById('panel'));   // Text Directions Panel
  
  var control = document.getElementById('floating-panel');        // Custom Route Options buttons
  control.style.display = 'block';
  map.controls[google.maps.ControlPosition.TOP_CENTER].push(control);

  document.getElementById('calc-route').addEventListener('click', function() {
    calculateAndDisplayRoute(directionsService, directionsDisplay);
  });

  

}


function getCurrentPosition() {
  if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (pos) {
          return new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude); 
          }, function() {
            console.log("error getting location");
          });
  } else {
    // Browser doesn't support Geolocation
    console.log("browser doesn't support geolaction");
    return;
  }
}



/**
    
  */
function calculateAndDisplayRoute(directionsService, directionsDisplay) {


    //debugger; //TODO: fix geolocation
    if (document.getElementById("from-current-loc").checked) {
        origin = getCurrentPosition();
    } else if (document.getElementById("from-cvo").checked) {
        origin = CVO_ADDR;
    } else if (document.getElementById("from-other").checked) {
        origin = document.getElementById("from-other-input").value;
    } else {
      return;
    }

    if (document.getElementById("to-current-loc").checked) {
        dest = getCurrentPosition();
    } else if (document.getElementById("to-cvo").checked) {
        dest = CVO_ADDR;
    } else if (document.getElementById("to-other").checked) {
        dest = document.getElementById("to-other-input").value;
    } else {
      return;
    }

  // var address_count = 0;
  var regex_addr = "/[A-Za-z0-9'\.\-\s\,]*/"; // Validating address input

  for (var i = 0; i < document.getElementById("stop-input").childElementCount; i++) {  
    var divc = document.getElementById("stop-input").children;
    var lic = divc[i].children; 
    var wp = lic[0].value;
    //debugger;
    if (wp.length==0) continue;   // Ignore empty fields
    //wp = escapeHtml(wp); 
    /*
    if (!wp.match(regex_addr)) { 
      window.alert("Please provide valid input");
      return;
    }*/
    wps.push({location: wp});     // Add waypoint objects
  } 

 

  directionsService.route({ // Create Route
    origin: origin, 
    destination: dest, 
    optimizeWaypoints: true, // By least time
    waypoints: wps,
    travelMode: 'DRIVING'
  }, function(response, status) {
    if (status === 'OK') {
      directionsDisplay.setDirections(response);
      wpsOptmzdOrd = response.routes[0].waypoint_order; // Index 0 since only one route was requested
      document.getElementById("input").style.display = 'none';
      document.getElementById("calc-route").style.display = 'none';
      document.getElementById("panel").style.display = 'inline-block';
      document.getElementById("new-route").style.display = 'inline-block';
      document.getElementById("start-trip").style.display = 'inline-block';
    } else {
      window.alert('Directions request failed due to ' + status);
    }
  });

  
}


/**
  */
function addStop() {
  var newAddrItem = document.createElement("LI");
  var newAddrInput = document.createElement("INPUT");
  var newRemoveLink = document.createElement("div");

  newAddrItem.id = "addr" + addrTotal + "-item";
  newAddrItem.class = "addr-item";

  newAddrInput.id = "addr" + addrTotal++;

  var newRemoveText = document.createTextNode("X"); 
  newRemoveLink.style = "cursor: pointer";
  newRemoveLink .appendChild(newRemoveText);  

  newAddrItem.appendChild(newAddrInput);
  newAddrItem.appendChild(newRemoveLink);
  document.getElementById("stop-input").appendChild(newAddrItem);

  newRemoveLink.addEventListener('click', function () { removeStop(newAddrItem.id); });
}

function reset() {
  window.location.reload(false);  
}

function removeStop(id) { 
  var elem = document.getElementById(id);
  elem.parentNode.removeChild(elem);
}

function goToUrl() {
  var wpsString = "";
  var i = 0;
  console.log(wpsOptmzdOrd.length);
  for (; i < wpsOptmzdOrd.length-1; i++) {
    wpsString += wps[wpsOptmzdOrd[i]].location+"|";
    console.log(wpsString);
  }
  wpsString += wps[wpsOptmzdOrd[i]].location;
  console.log(wpsString);
  var reqUrl = "https://www.google.com/maps/dir/?api=1&origin="+CVO_ADDR+"&destination="+CVO_ADDr+
  "&travelmode=driving&dir_action=navigate&waypoints=" + wpsString;
  window.location.href = encodeURI(reqUrl);
}


function escapeHtml(text) {
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

</script>



<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDNzOFVil7vy2ciyRuAIxRf4yxHHBiO268&callback=initMap">
</script>



</body>
</html>
